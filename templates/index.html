<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQ System - –°–µ—Ä–≤–∏—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background-color: #424242;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        .logout-button {
            padding: 10px 20px;
            background-color: #5a5a5a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .logout-button:hover {
            background-color: #d32f2f;
        }
        
        .header-menu {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-menu a {
            padding: 8px 16px;
            background-color: #5a5a5a;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .header-menu a:hover {
            background-color: #6a6a6a;
        }
        
        .header-menu a.primary {
            background-color: #2196F3;
        }
        
        .header-menu a.primary:hover {
            background-color: #1976D2;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .welcome-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .welcome-section h1 {
            font-size: 36px;
            color: #333;
            margin-bottom: 20px;
        }
        
        .welcome-section p {
            font-size: 18px;
            color: #666;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto 30px;
        }
        
        .auth-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .auth-button {
            padding: 14px 28px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .auth-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .auth-button.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .header-menu {
                flex-direction: column;
                gap: 8px;
            }
            
            .header-menu a {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .welcome-section {
                padding: 30px 20px;
            }
            
            .welcome-section h1 {
                font-size: 28px;
            }
            
            .welcome-section p {
                font-size: 16px;
            }
            
            .auth-buttons {
                flex-direction: column;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .card-header.blue {
            background-color: #2196F3;
            color: white;
        }
        
        .card-header.yellow {
            background-color: #FFC107;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .user-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .user-info {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .user-info strong {
            color: #333;
        }
        
        .subscription-info {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .subscription-plan {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin-top: 10px;
        }
        
        .api-info {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .api-info h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .api-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .api-link {
            display: inline-block;
            padding: 12px 20px;
            background-color: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .api-link:hover {
            background-color: #1976D2;
        }
        
        .api-link.secondary {
            background-color: #4CAF50;
        }
        
        .api-link.secondary:hover {
            background-color: #45a049;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .user-name {
                font-size: 24px;
            }
            
            .subscription-plan {
                font-size: 20px;
            }
            
            .header {
                padding: 12px 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logout-button {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .header-left {
                gap: 8px;
            }
            
            .logo-icon {
                width: 24px;
                height: 24px;
                margin-right: 0;
            }
            
            .card-header {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .user-name {
                font-size: 20px;
            }
            
            .api-info {
                padding: 20px;
            }
            
            .api-link {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .logout-button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        .footer {
            background-color: #424242;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            font-size: 14px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span class="logo-icon"></span>
            <span class="logo">IQ System</span>
        </div>
        <div class="header-menu" id="header-menu">
            <a href="/login/" class="primary">–í–æ–π—Ç–∏</a>
            <a href="/register/">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
        <button class="logout-button hidden" id="logout-button" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
    
    <div class="container">
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="guest-section">
            <div class="welcome-section">
                <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ IQ System</h1>
                <p>
                    IQ System ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º 
                    –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ù–∞—à–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã 
                    –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Å–∏—Ö–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
                </p>
                <p>
                    –ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ç—Ä–∏ —Ç–∏–ø–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
                </p>
                <ul style="text-align: left; max-width: 600px; margin: 0 auto 30px; font-size: 16px; color: #666; line-height: 1.8;">
                    <li><strong>IQ-—Ç–µ—Å—Ç</strong> ‚Äî –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è (60 –≤–æ–ø—Ä–æ—Å–æ–≤, 20 –º–∏–Ω—É—Ç)</li>
                    <li><strong>–û—Ü–µ–Ω–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤</strong> ‚Äî –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ 10 –ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (200 –≤–æ–ø—Ä–æ—Å–æ–≤, 35 –º–∏–Ω—É—Ç)</li>
                    <li><strong>–û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</strong> ‚Äî –∞–Ω–∞–ª–∏–∑ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (20 –≤–æ–ø—Ä–æ—Å–æ–≤, 10 –º–∏–Ω—É—Ç)</li>
                </ul>
                <p>
                    –ù–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
                </p>
                <div class="auth-buttons">
                    <a href="/register/" class="auth-button primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    <a href="/login/" class="auth-button secondary">–í–æ–π—Ç–∏</a>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="user-section" class="hidden">
            <div class="content-grid">
                <div class="card">
                    <div class="card-header blue">User profile</div>
                    <div class="card-body">
                        <div class="user-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="user-info">
                            <strong>Email:</strong> <span id="user-email">-</span>
                        </div>
                        <div class="user-info" id="company-name" style="margin-top: 10px;">
                            <strong>–ö–æ–º–ø–∞–Ω–∏—è:</strong> <span id="company-name-value">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header yellow">
                        <span>‚≠ê</span>
                        <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</span>
                    </div>
                    <div class="card-body">
                        <div class="subscription-info">–í–∞—à —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ:</div>
                        <div class="subscription-plan" id="subscription-plan">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</div>
                        <div class="subscription-info" style="margin-top: 15px;">
                            –û—Å—Ç–∞–ª–æ—Å—å —Ç–µ—Å—Ç–æ–≤: <span id="remaining-tests">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞ —Å–æ–∏—Å–∫–∞—Ç–µ–ª—é -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="background-color: #4CAF50; color: white;">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç —Å–æ–∏—Å–∫–∞—Ç–µ–ª—é
                </div>
                <div class="card-body">
                    <form id="send-test-form">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="test-select" style="display: block; margin-bottom: 5px; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç:</label>
                            <select id="test-select" name="test_id" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white; cursor: pointer;">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç --</option>
                            </select>
                            <div id="tests-loading" style="margin-top: 5px; font-size: 12px; color: #666; display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤...</div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="candidate-email" style="display: block; margin-bottom: 5px; font-weight: 500;">Email —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è *:</label>
                            <input type="email" id="candidate-email" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="candidate@example.com">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="candidate-name" style="display: block; margin-bottom: 5px; font-weight: 500;">–ò–º—è —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                            <input type="text" id="candidate-name" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="candidate-age" style="display: block; margin-bottom: 5px; font-weight: 500;">–í–æ–∑—Ä–∞—Å—Ç —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                            <input type="number" id="candidate-age" min="14" max="100" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="30">
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
                        </button>
                        
                        <div id="send-test-message" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                    </form>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="background-color: #2196F3; color: white;">
                    –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
                </div>
                <div class="card-body">
                    <div id="test-sessions-list">
                        <div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å —Ç–æ–∫–µ–Ω–æ–º
        function getAuthHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        async function refreshToken() {
            const refresh = localStorage.getItem('refresh_token');
            if (!refresh) {
                return false;
            }
            
            try {
                const response = await fetch('/api/accounts/token/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refresh })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    return true;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/login/';
            return false;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...getAuthHeaders(), ...options.headers };
            
            let response = await fetch(url, options);
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–∏—Ç—å
            if (response.status === 401) {
                const refreshed = await refreshToken();
                if (refreshed) {
                    options.headers = getAuthHeaders();
                    response = await fetch(url, options);
                }
            }
            
            return response;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const guestSection = document.getElementById('guest-section');
            const userSection = document.getElementById('user-section');
            const headerMenu = document.getElementById('header-menu');
            const logoutButton = document.getElementById('logout-button');
            
            if (token) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ —Å–µ–∫—Ü–∏—é
                guestSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                headerMenu.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–µ—Å—Ç—ã –∏ —Å–µ—Å—Å–∏–∏
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –æ–±–Ω–æ–≤–ª–µ–Ω
                requestAnimationFrame(() => {
                    loadUserData();
                    loadTestSessions();
                    // setupSendTestForm() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞
                    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ —Ç–æ—á–Ω–æ –±—ã–ª–∞ –≤–∏–¥–∏–º–∞
                    setTimeout(() => {
                        loadTests();
                    }, 200);
                });
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
                guestSection.classList.remove('hidden');
                userSection.classList.add('hidden');
                headerMenu.classList.remove('hidden');
                logoutButton.classList.add('hidden');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                return;
            }
            
            try {
                const response = await fetchWithAuth('/api/accounts/users/profile/');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('user-name').textContent = data.username || data.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    document.getElementById('user-email').textContent = data.email || '-';
                    document.getElementById('company-name-value').textContent = data.company_name || '-';
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                document.getElementById('user-name').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('user-email').textContent = '-';
                document.getElementById('company-name-value').textContent = '-';
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
            try {
                const response = await fetchWithAuth('/api/accounts/subscriptions/current/');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('subscription-plan').textContent = data.plan?.name || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    document.getElementById('remaining-tests').textContent = data.remaining_tests || 0;
                } else {
                    document.getElementById('subscription-plan').textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
                    document.getElementById('remaining-tests').textContent = '0';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                document.getElementById('subscription-plan').textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        async function loadTests() {
            // –ü–æ–¥–æ–∂–¥–∞—Ç—å, –ø–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ DOM
            let attempts = 0;
            let testSelect = document.getElementById('test-select');
            
            while (!testSelect && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                testSelect = document.getElementById('test-select');
                attempts++;
            }
            
            if (!testSelect) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç test-select –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è');
                return;
            }
            
            const loadingDiv = document.getElementById('tests-loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
            
            try {
                const response = await fetch('/api/tests/tests/');
                if (response.ok) {
                    const data = await response.json();
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω (Django REST Framework)
                    let tests = [];
                    if (Array.isArray(data)) {
                        tests = data;
                    } else if (data.results && Array.isArray(data.results)) {
                        tests = data.results;
                    } else if (data.results && !Array.isArray(data.results)) {
                        tests = [data.results];
                    } else {
                        tests = [];
                    }
                    
                    testSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç --</option>';
                    
                    if (tests.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '–¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                        option.disabled = true;
                        testSelect.appendChild(option);
                        console.warn('–¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç–µ API');
                        return;
                    }
                    
                    tests.forEach(test => {
                        const option = document.createElement('option');
                        option.value = test.id;
                        option.textContent = `${test.name} (${test.duration_minutes} –º–∏–Ω, ${test.questions_count} –≤–æ–ø—Ä–æ—Å–æ–≤)`;
                        testSelect.appendChild(option);
                    });
                    
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:', tests.length);
                    
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                    const errorText = await response.text().catch(() => '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏');
                    console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    testSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤</option>';
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤:', error);
                if (testSelect) {
                    testSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</option>';
                }
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        async function loadTestSessions() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                return;
            }
            
            const sessionsList = document.getElementById('test-sessions-list');
            sessionsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const response = await fetchWithAuth('/api/tests/sessions/my_sessions/');
                if (response.ok) {
                    const sessions = await response.json();
                    
                    if (sessions.length === 0) {
                        sessionsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</div>';
                        return;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                    let tableHTML = `
                        <style>
                            #test-sessions-table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 14px;
                                background-color: white;
                            }
                            #test-sessions-table thead tr {
                                background-color: #f5f5f5;
                                border-bottom: 2px solid #ddd;
                            }
                            #test-sessions-table th {
                                padding: 12px;
                                text-align: left;
                                font-weight: 600;
                                color: #333;
                            }
                            #test-sessions-table tbody tr {
                                border-bottom: 1px solid #e0e0e0;
                                transition: background-color 0.2s;
                            }
                            #test-sessions-table tbody tr:hover {
                                background-color: #f9f9f9;
                            }
                            #test-sessions-table td {
                                padding: 12px;
                                vertical-align: middle;
                            }
                            #test-sessions-table .status-badge {
                                display: inline-block;
                                padding: 4px 12px;
                                border-radius: 12px;
                                font-weight: 500;
                                font-size: 12px;
                            }
                            #test-sessions-table .action-buttons {
                                display: flex;
                                gap: 8px;
                                justify-content: center;
                                flex-wrap: wrap;
                            }
                            #test-sessions-table button {
                                padding: 6px 12px;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                                white-space: nowrap;
                                transition: opacity 0.2s;
                            }
                            #test-sessions-table button:hover {
                                opacity: 0.9;
                            }
                            #test-sessions-table button:active {
                                opacity: 0.7;
                            }
                        </style>
                        <div style="overflow-x: auto;">
                            <table id="test-sessions-table">
                                <thead>
                                    <tr>
                                        <th>–°–æ–∏—Å–∫–∞—Ç–µ–ª—å</th>
                                        <th>–¢–µ—Å—Ç</th>
                                        <th>Email</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–°–æ–∑–¥–∞–Ω</th>
                                        <th>–ó–∞–≤–µ—Ä—à–µ–Ω</th>
                                        <th style="text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sessions.forEach(session => {
                        const statusMap = {
                            'pending': { text: '–û–∂–∏–¥–∞–µ—Ç', color: '#ff9800' },
                            'in_progress': { text: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', color: '#2196F3' },
                            'completed': { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', color: '#4CAF50' },
                            'expired': { text: '–ò—Å—Ç–µ–∫', color: '#9e9e9e' }
                        };
                        
                        const status = statusMap[session.status] || { text: session.status, color: '#9e9e9e' };
                        const testLink = `${window.location.origin}/test/${session.id}/`;
                        const fullTestLink = `${window.location.protocol}//${window.location.host}/test/${session.id}/`;
                        
                        const createdDate = new Date(session.created_at).toLocaleString('ru-RU');
                        const completedDate = session.completed_at ? new Date(session.completed_at).toLocaleString('ru-RU') : '-';
                        
                        tableHTML += `
                            <tr>
                                <td>${session.candidate_name || session.candidate_email}</td>
                                <td>${session.test.name}</td>
                                <td>${session.candidate_email}</td>
                                <td>
                                    <span class="status-badge" style="background-color: ${status.color}20; color: ${status.color};">
                                        ${status.text}
                                    </span>
                                </td>
                                <td>${createdDate}</td>
                                <td>${completedDate}</td>
                                <td>
                                    <div class="action-buttons">
                                        ${session.status === 'pending' || session.status === 'in_progress' ? `
                                            <button onclick="copyTestLink('${session.id}', '${fullTestLink}')" style="background-color: #2196F3;" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ—Å—Ç">
                                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                        ` : ''}
                                        ${session.status === 'completed' ? `
                                            <button onclick="viewResult('${session.id}')" style="background-color: #4CAF50;" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç">
                                                üìä –û—Ç—á–µ—Ç
                                            </button>
                                        ` : ''}
                                        <button onclick="deleteSession('${session.id}')" style="background-color: #f44336;" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å">
                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    sessionsList.innerHTML = tableHTML;
                } else {
                    sessionsList.innerHTML = '<div style="text-align: center; color: #c62828; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–π:', error);
                sessionsList.innerHTML = '<div style="text-align: center; color: #c62828; padding: 20px;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–µ—Å—Ç
        async function copyTestLink(sessionId, link) {
            try {
                await navigator.clipboard.writeText(link);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = link;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                } catch (e) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –í–æ—Ç —Å—Å—ã–ª–∫–∞: ' + link);
                }
                document.body.removeChild(textArea);
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        async function deleteSession(sessionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            try {
                const response = await fetchWithAuth(`/api/tests/sessions/${sessionId}/`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
                    loadTestSessions(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    loadUserData(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤
                } else {
                    const data = await response.json();
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        async function viewResult(sessionId) {
            try {
                const response = await fetchWithAuth(`/api/tests/sessions/${sessionId}/get_result/`);
                if (response.ok) {
                    const result = await response.json();
                    
                    // –°–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        padding: 20px;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        border-radius: 12px;
                        padding: 30px;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                    `;
                    
                    modalContent.innerHTML = `
                        <button onclick="this.closest('[style*=fixed]').remove()" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            background: #f5f5f5;
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            cursor: pointer;
                            font-size: 20px;
                        ">√ó</button>
                        <h2 style="margin-bottom: 20px; color: #333;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                        <div style="margin-bottom: 15px;">
                            <strong>–°–æ–∏—Å–∫–∞—Ç–µ–ª—å:</strong> ${result.session.candidate_name || result.session.candidate_email}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Email:</strong> ${result.session.candidate_email}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>–¢–µ—Å—Ç:</strong> ${result.session.test.name}
                        </div>
                        ${result.iq_score ? `<div style="margin-bottom: 15px;"><strong>IQ:</strong> ${result.iq_score} (${result.iq_level || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'})</div>` : ''}
                        ${result.raw_score !== null ? `<div style="margin-bottom: 15px;"><strong>–°—ã—Ä–æ–π –±–∞–ª–ª:</strong> ${result.raw_score}</div>` : ''}
                        <div style="margin-top: 20px; margin-bottom: 20px; text-align: center;">
                            <button onclick="downloadPdfReport('${sessionId}')" style="padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
                                üì• –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç
                            </button>
                        </div>
                        <div style="margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px;">${result.report || '–û—Ç—á–µ—Ç –µ—â–µ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω'}</div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                } else {
                    const error = await response.json();
                    alert(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF –æ—Ç—á–µ—Ç–∞ (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ ReportLab)
        async function downloadPdfReport(sessionId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º PDF —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetchWithAuth(`/api/tests/sessions/${sessionId}/download_pdf/`);
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF' }));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF');
                }
                
                // –ü–æ–ª—É—á–∞–µ–º PDF –∫–∞–∫ blob
                const blob = await response.blob();
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Content-Disposition
                const contentDisposition = response.headers.get('Content-Disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/);
                    if (filenameMatch) {
                        a.download = decodeURIComponent(filenameMatch[1]);
                    } else {
                        const simpleMatch = contentDisposition.match(/filename="(.+)"/);
                        if (simpleMatch) {
                            a.download = simpleMatch[1];
                        } else {
                            a.download = `–û—Ç—á–µ—Ç_${sessionId}.pdf`;
                        }
                    }
                } else {
                    a.download = `–û—Ç—á–µ—Ç_${sessionId}.pdf`;
                }
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –æ—Ç—á–µ—Ç–∞: ' + error.message);
            }
        }
        
        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                checkAuth(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            }
        }
        
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –±—ã–ª –ª–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        let sendTestFormHandlerAdded = false;
        let isSubmittingTest = false;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞
        function setupSendTestForm() {
            const sendTestForm = document.getElementById('send-test-form');
            if (sendTestForm && !sendTestFormHandlerAdded) {
                sendTestFormHandlerAdded = true;
                
                sendTestForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                    if (isSubmittingTest) {
                        console.log('–§–æ—Ä–º–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                        return false;
                    }
                    
                    const testSelect = document.getElementById('test-select');
                    const candidateEmail = document.getElementById('candidate-email');
                    const candidateName = document.getElementById('candidate-name');
                    const candidateAge = document.getElementById('candidate-age');
                    const messageDiv = document.getElementById('send-test-message');
                    const submitBtn = sendTestForm.querySelector('button[type="submit"]');
                    
                    // –í–∞–ª–∏–¥–∞—Ü–∏—è
                    if (!testSelect.value) {
                        messageDiv.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#c62828';
                        messageDiv.style.display = 'block';
                        return false;
                    }
                    
                    if (!candidateEmail.value) {
                        messageDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ email —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#c62828';
                        messageDiv.style.display = 'block';
                        return false;
                    }
                    
                    messageDiv.style.display = 'none';
                    submitBtn.disabled = true;
                    isSubmittingTest = true;
                    
                    const formData = {
                        test_id: parseInt(testSelect.value),
                        candidate_email: candidateEmail.value.trim(),
                        candidate_name: candidateName.value.trim() || '',
                        candidate_age: candidateAge.value ? parseInt(candidateAge.value) : null
                    };
                    
                    try {
                        const response = await fetchWithAuth('/api/tests/sessions/create_session/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            messageDiv.textContent = `–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${formData.candidate_email}! –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ email.`;
                            messageDiv.style.background = '#e8f5e9';
                            messageDiv.style.color = '#2e7d32';
                            messageDiv.style.display = 'block';
                            
                            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            sendTestForm.reset();
                            
                            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–∫—É
                            loadTestSessions();
                            loadUserData();
                        } else {
                            messageDiv.textContent = data.error || data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞';
                            messageDiv.style.background = '#ffebee';
                            messageDiv.style.color = '#c62828';
                            messageDiv.style.display = 'block';
                        }
                    } catch (error) {
                        messageDiv.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#c62828';
                        messageDiv.style.display = 'block';
                        console.error('–û—à–∏–±–∫–∞:', error);
                    } finally {
                        submitBtn.disabled = false;
                        isSubmittingTest = false;
                    }
                    
                    return false;
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        checkAuth();
        setupSendTestForm();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≥–æ–¥ –≤ —Ñ—É—Ç–µ—Ä–µ
        document.addEventListener('DOMContentLoaded', function() {
            const yearElement = document.getElementById('current-year');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
        });
    </script>
    <footer class="footer">
        <div class="footer-content">
            –¢–û–û "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã" ¬© <span id="current-year">2025</span>
        </div>
    </footer>
</body>
</html>
