name: Deploy to Production

on:
  push:
    branches:
      - main  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ master, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ master

jobs:
  deploy:
    runs-on: self-hosted  # –ò—Å–ø–æ–ª—å–∑—É–µ–º self-hosted runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy application
        run: |
          set -e
          
          cd /var/www/personnel_testing
          
          echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git safe.directory..."
          git config --global --add safe.directory /var/www/personnel_testing
          
          echo "üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É..."
          # –£–∑–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (runner)
          RUNNER_USER=$(whoami)
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          sudo chown -R $RUNNER_USER:$RUNNER_USER /var/www/personnel_testing || true
          sudo chmod -R u+w /var/www/personnel_testing || true
          
          echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
          git fetch origin
          git reset --hard origin/main
          
          echo "üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          source venv/bin/activate
          
          echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
          
          echo "üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
          python manage.py makemigrations --noinput || true
          
          echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
          python manage.py migrate --noinput
          
          echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ static (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
          mkdir -p static || true
          
          echo "üìÅ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
          python manage.py collectstatic --noinput
          
          echo "üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –ª–æ–≥–∏ –∏ —Å–æ–∫–µ—Ç..."
          # –£–∑–Ω–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Gunicorn –∏–∑ systemd service
          GUNICORN_USER=$(systemctl show -p User personnel_testing.service 2>/dev/null | cut -d= -f2 || echo "ubuntu")
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é logs, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          sudo mkdir -p /var/www/personnel_testing/logs
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –ª–æ–≥–∏ –∏ —Å–æ–∫–µ—Ç –¥–ª—è Gunicorn
          sudo chown -R $GUNICORN_USER:$GUNICORN_USER /var/www/personnel_testing/logs
          sudo chmod -R u+w /var/www/personnel_testing/logs
          # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∫–µ—Ç (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
          if [ -S /var/www/personnel_testing/personnel_testing.sock ]; then
              sudo chown $GUNICORN_USER:$GUNICORN_USER /var/www/personnel_testing/personnel_testing.sock
          fi
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Gunicorn..."
          sudo systemctl restart personnel_testing || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Gunicorn, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
          
          echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
          sudo nginx -t && sudo systemctl reload nginx || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Nginx, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
