"""
Сервис обработки результатов теста продуктивности с использованием Gemini AI
"""
from .gemini_service import call_gemini


def process_productivity_test(answers_data):
    """
    Обработать результаты теста продуктивности с помощью Gemini AI
    
    Args:
        answers_data: список ответов [{'question_number': int, 'answer': str}, ...]
    """
    # Формируем текст с ответами кандидата
    answers_text = "ОТВЕТЫ КАНДИДАТА:\n\n"
    for answer_data in answers_data:
        q_num = answer_data['question_number']
        answer_text = answer_data.get('answer', '')
        answers_text += f"Вопрос {q_num}: {answer_text}\n\n"
    
    # Промпт для Gemini согласно методологии
    prompt = f"""Ты — эксперт-методолог по найму и оценке персонала. Твоя задача — проанализировать ответы кандидата на тест "Оценка продуктивности" и составить отчет, определяющий его эффективность.

В своей оценке ты должен строго руководствоваться следующей методологией анализа маркеров:

### ИНСТРУКЦИЯ ПО АНАЛИЗУ (МЕТОДОЛОГИЯ)
Твоя главная цель — определить, кто перед тобой: "Процессник" (ориентирован на действие) или "Результатник" (ориентирован на итог).

1. Ищи маркеры "Процессника" (Низкая продуктивность):
- Использует глаголы несовершенного вида: «Занимался», «Участвовал», «Отвечал за работу», «Старался выполнять», «Делал».
- Отсутствуют конкретные цифры и факты.
- Присутствуют жалобы на внешние обстоятельства (кризис, рынок, плохое руководство, отсутствие бюджета).

2. Ищи маркеры "Результатника" (Высокая продуктивность):
- Использует глаголы совершенного вида: «Сделал», «Внедрил», «Увеличил на 20%», «Выполнил», «Завершил».
- Приводит конкретные цифры (деньги, проценты, штуки).
- Сравнивает свои успехи с планом или другими сотрудниками.

---

### ВХОДНЫЕ ДАННЫЕ (ОТВЕТЫ КАНДИДАТА):
{answers_text}

---

### ФОРМАТ ОТЧЕТА
Проанализируй текст ответов и сформируй отчет по следующим 5 пунктам. В каждом пункте дай развернутый комментарий и приводи цитаты из ответов кандидата в качестве доказательства.

1. ПОНИМАНИЕ ОЖИДАНИЙ (Блок "Продукт должности")
- Понимает ли человек, что от него ожидает работодатель и за что он получает зарплату?
- Может ли он сформулировать свой "Ценный Конечный Продукт" (результат), или он описывает набор обязанностей (процесс)?

2. ИЗМЕРЕНИЕ РЕЗУЛЬТАТОВ
- Измеряет ли кандидат результаты своей работы?
- Способен ли он привести точные показатели (KPI, объемы, деньги)?
- Есть ли в ответах конкретные цифры или только общие фразы ("улучшал", "развивал")?

3. КОНТЕКСТ И СРАВНЕНИЕ
- Сравнивает ли кандидат свои результаты с результатами других людей на аналогичных должностях (рейтинги, топы)?
- Понимает ли он масштаб своих достижений относительно плана (План/Факт)?

4. ДИНАМИКА И ОТВЕТСТВЕННОСТЬ
- Как изменялся уровень ответственности и должностных обязанностей на предыдущих местах работы?
- Есть ли примеры расширения зоны влияния или это стагнация?
- Брал ли он ответственность сверх инструкции?

5. ЛИЧНЫЙ ПОТЕНЦИАЛ (ВНЕ РАБОТЫ)
- Какие достижения, увлечения, предметы для гордости, успехи в спорте и жизни есть у кандидата за пределами работы?
- Есть ли признаки "спортивной злости" и привычки побеждать в жизни?

### ИТОГОВЫЙ ВЕРДИКТ:
На основе анализа сделай вывод: К какому типу относится кандидат ("Процессник" или "Результатник")? Стоит ли рассматривать его на должность, требующую высокой автономности и достижения целей?

ВАЖНО: Отчет должен быть на одной странице. В отчете отображаются ответы Соискателя."""
    
    try:
        # Вызываем Gemini API
        report = call_gemini(prompt)
        
        # Определяем тип кандидата из отчета
        candidate_type = 'Смешанный тип'
        if 'Результатник' in report:
            candidate_type = 'Результатник'
        elif 'Процессник' in report:
            candidate_type = 'Процессник'
        
        report_json = {
            'candidate_type': candidate_type,
            'answers': answers_data,
            'full_report': report,
        }
        
        return {
            'report': report,
            'report_json': report_json,
        }
    except Exception as e:
        # Fallback на простую обработку при ошибке API
        return {
            'report': f"Ошибка обработки с помощью ИИ: {str(e)}\n\nОтветы кандидата:\n{answers_text}",
            'report_json': {
                'error': str(e),
                'answers': answers_data,
            },
        }
