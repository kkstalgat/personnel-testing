"""
Сервис обработки результатов IQ-теста с использованием Gemini AI для формирования отчета
"""
from tests.data.raven_test import (
    get_correct_answer,
    get_iq_from_raw_score,
    calculate_final_iq,
    get_iq_level,
)
from .gemini_service import call_gemini


def process_raven_test(session, answers):
    """
    Обработать результаты IQ-теста
    
    Args:
        session: TestSession объект
        answers: список ответов в формате [{'question_number': int, 'answer': int}, ...]
                 answer - число от 1 до 8
    """
    # Подсчет сырого балла
    raw_score = 0
    series_scores = {
        'A': 0,
        'B': 0,
        'C': 0,
        'D': 0,
        'E': 0,
    }
    
    # Формируем ответы по сериям для отчета
    series_answers = {
        'A': [],
        'B': [],
        'C': [],
        'D': [],
        'E': [],
    }
    
    for answer_data in answers:
        question_num = answer_data['question_number']
        user_answer = int(answer_data['answer'])
        correct_answer = get_correct_answer(question_num)
        
        # Определить серию
        if 1 <= question_num <= 12:
            series = 'A'
        elif 13 <= question_num <= 24:
            series = 'B'
        elif 25 <= question_num <= 36:
            series = 'C'
        elif 37 <= question_num <= 48:
            series = 'D'
        elif 49 <= question_num <= 60:
            series = 'E'
        else:
            continue
        
        if user_answer == correct_answer:
            raw_score += 1
            series_scores[series] += 1
        
        series_answers[series].append({
            'question': question_num,
            'user_answer': user_answer,
            'correct': correct_answer,
            'is_correct': user_answer == correct_answer,
        })
    
    # Определение базового IQ
    base_iq = get_iq_from_raw_score(raw_score)
    
    # Корректировка на возраст
    age = session.candidate_age or 30  # По умолчанию 30 лет
    final_iq = calculate_final_iq(base_iq, age)
    iq_level = get_iq_level(final_iq)
    
    # Проверка надежности
    reliability_warning = ""
    if series_scores['D'] + series_scores['E'] > series_scores['A'] + series_scores['B']:
        reliability_warning = "Внимание: Результат может быть недостоверным (случайное угадывание). Обычно результативность падает от A к E."
    
    # Формируем данные для Gemini
    answers_text = f"""ВОЗРАСТ КАНДИДАТА: {age} лет

ОТВЕТЫ ПО СЕРИЯМ:
Серия A (вопросы 1-12): {series_scores['A']} из 12 правильных
Серия B (вопросы 13-24): {series_scores['B']} из 12 правильных
Серия C (вопросы 25-36): {series_scores['C']} из 12 правильных
Серия D (вопросы 37-48): {series_scores['D']} из 12 правильных
Серия E (вопросы 49-60): {series_scores['E']} из 12 правильных

ОБЩИЙ СЫРОЙ БАЛЛ: {raw_score} из 60
БАЗОВЫЙ IQ (по таблице): {base_iq}
ИТОГОВЫЙ IQ (с учетом возраста): {final_iq}
УРОВЕНЬ РАЗВИТИЯ: {iq_level}"""
    
    # Промпт для Gemini согласно методологии
    prompt = f"""Ты — профессиональный психометрист и HR-методолог. Твоя задача — обработать результаты тестирования кандидата по IQ-тесту (прогрессивные матрицы Равена) и сформировать итоговое заключение.

### АЛГОРИТМ РАБОТЫ (СТРОГО ПО ИНСТРУКЦИИ):

ШАГ 1. ПРОВЕРКА ОТВЕТОВ (КЛЮЧ)
Ключ к тесту:
- Серия A: 4, 5, 1, 2, 6, 3, 6, 2, 1, 3, 4, 5
- Серия B: 2, 6, 1, 2, 1, 3, 5, 6, 4, 3, 4, 5
- Серия C: 8, 2, 3, 8, 7, 4, 5, 1, 7, 6, 1, 2
- Серия D: 3, 4, 3, 7, 8, 6, 5, 4, 1, 2, 5, 6
- Серия E: 7, 6, 8, 2, 1, 5, 1, 6, 3, 2, 4, 5

ШАГ 2. ОПРЕДЕЛЕНИЕ БАЗОВОГО IQ
Используй таблицу перевода "Сырой балл -> IQ":
- 60 баллов = IQ 140
- 55-59 баллов = IQ 122-130
- 50-54 балла = IQ 112-120
- 45-49 баллов = IQ 102-110
- 40-44 балла = IQ 95-100
- 35-39 баллов = IQ 88-94
- 30-34 балла = IQ 82-87
- 25-29 баллов = IQ 75-80
- Менее 24 баллов = IQ < 70 (Низкий интеллект).

ШАГ 3. КОРРЕКТИРОВКА НА ВОЗРАСТ
Примени формулу: IQ_final = (IQ_base / %) * 100.
Коэффициенты (%):
- 14-30 лет: 100%
- 35 лет: 97%
- 40 лет: 93%
- 45 лет: 88%
- 50 лет: 82%
- 55 лет: 76%
- 60 лет: 70%

ШАГ 4. ОПРЕДЕЛЕНИЕ УРОВНЯ
Используй градацию:
- IQ > 121: Высокий / Незаурядный интеллект.
- IQ 111-120: Интеллект выше среднего.
- IQ 91-110: Средний интеллект.
- IQ 81-90: Интеллект ниже среднего.
- IQ < 80: Низкий уровень.

---

### ВХОДНЫЕ ДАННЫЕ КАНДИДАТА:
{answers_text}

---

### ФОРМАТ ОТЧЕТА (Выведи результат в таком виде):

## ОТЧЕТ ПО ТЕСТУ ИНТЕЛЛЕКТА (LOGIS/RAVEN)

1. РЕЗУЛЬТАТЫ ПО СЕРИЯМ:
- Серия A (Мышление по аналогии): [X] из 12
- Серия B (Линейная дифференциация): [X] из 12
- Серия C (Прогрессивные изменения): [X] из 12
- Серия D (Перегруппировка фигур): [X] из 12
- Серия E (Анализ и синтез): [X] из 12
**Общий сырой балл:** [СУММА] из 60.

2. ПОКАЗАТЕЛЬ IQ:
- Базовый IQ (по таблице): [...]
- **Итоговый IQ (с учетом возраста): [...]**
- **Уровень развития:** [Например: Высокий уровень интеллекта]

3. РЕКОМЕНДАЦИЯ ПО ДОЛЖНОСТИ:
Опираясь на уровень IQ, дай рекомендацию:
- *Если IQ > 111:* "Кандидат обладает высокой способностью к обучению и анализу. Рекомендован на руководящие позиции, работу с аналитикой, решение нестандартных задач (бизнесмен, администратор, топ-менеджер)."
- *Если IQ 91-110:* "Кандидат способен справляться со стандартными задачами. Рекомендован на позиции линейного сотрудника, специалиста, исполнителя."
- *Если IQ < 90:* "Кандидат может испытывать трудности с обучением и принятием самостоятельных решений. Рекомендован только на простые рутинные операции под контролем."

4. АНАЛИЗ НАДЕЖНОСТИ:
Если в последних сериях (D, E) баллов больше, чем в первых (A, B) — напиши предупреждение: "Внимание: Результат может быть недостоверным (случайное угадывание)". Обычно результативность падает от A к E."""
    
    try:
        # Вызываем Gemini API для формирования отчета
        report = call_gemini(prompt)
    except Exception as e:
        # Fallback на базовый отчет при ошибке API
        job_recommendation = ""
        if final_iq > 111:
            job_recommendation = "Кандидат обладает высокой способностью к обучению и анализу. Рекомендован на руководящие позиции, работу с аналитикой, решение нестандартных задач (бизнесмен, администратор, топ-менеджер)."
        elif 91 <= final_iq <= 110:
            job_recommendation = "Кандидат способен справляться со стандартными задачами. Рекомендован на позиции линейного сотрудника, специалиста, исполнителя."
        elif final_iq < 90:
            job_recommendation = "Кандидат может испытывать трудности с обучением и принятием самостоятельных решений. Рекомендован только на простые рутинные операции под контролем."
        
        report = f"""## ОТЧЕТ ПО ТЕСТУ ИНТЕЛЛЕКТА (LOGIS/RAVEN)

1. РЕЗУЛЬТАТЫ ПО СЕРИЯМ:
- Серия A (Мышление по аналогии): {series_scores['A']} из 12
- Серия B (Линейная дифференциация): {series_scores['B']} из 12
- Серия C (Прогрессивные изменения): {series_scores['C']} из 12
- Серия D (Перегруппировка фигур): {series_scores['D']} из 12
- Серия E (Анализ и синтез): {series_scores['E']} из 12
**Общий сырой балл:** {raw_score} из 60.

2. ПОКАЗАТЕЛЬ IQ:
- Базовый IQ (по таблице): {base_iq}
- **Итоговый IQ (с учетом возраста {age} лет): {final_iq}**
- **Уровень развития:** {iq_level}

3. РЕКОМЕНДАЦИЯ ПО ДОЛЖНОСТИ:
{job_recommendation}

4. АНАЛИЗ НАДЕЖНОСТИ:
{reliability_warning if reliability_warning else "Результаты теста соответствуют ожидаемому паттерну."}

Ошибка обработки с помощью ИИ: {str(e)}"""
    
    report_json = {
        'series_scores': series_scores,
        'raw_score': raw_score,
        'base_iq': base_iq,
        'final_iq': final_iq,
        'iq_level': iq_level,
        'age': age,
        'job_recommendation': job_recommendation if 'job_recommendation' in locals() else '',
        'reliability_warning': reliability_warning,
    }
    
    return {
        'raw_score': raw_score,
        'iq_score': final_iq,
        'iq_level': iq_level,
        'report': report,
        'report_json': report_json,
    }
