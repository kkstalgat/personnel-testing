"""
Сервис обработки результатов теста личностных качеств с использованием Gemini AI
"""
from .gemini_service import call_gemini


def process_personal_qualities_test(answers_data, questions_data=None):
    """
    Обработать результаты теста личностных качеств с помощью Gemini AI
    
    Args:
        answers_data: список ответов [{'question_number': int, 'answer': str, 'block_name': str, 'question_type': str}, ...]
        questions_data: словарь с вопросами (опционально) для формирования полного промпта
    """
    # Группируем ответы по блокам
    blocks = {}
    for answer_data in answers_data:
        block_name = answer_data.get('block_name', 'Неизвестный блок')
        if block_name not in blocks:
            blocks[block_name] = []
        
        q_num = answer_data.get('question_number', 0)
        answer = answer_data.get('answer', '')
        q_type = answer_data.get('question_type', '+')
        
        # Преобразуем ответы в формат Да/Нет/Иногда
        answer_text = answer
        if answer.lower() in ['yes', 'да']:
            answer_text = 'Да'
        elif answer.lower() in ['no', 'нет']:
            answer_text = 'Нет'
        elif answer.lower() in ['sometimes', 'иногда']:
            answer_text = 'Иногда'
        
        blocks[block_name].append({
            'question_number': q_num,
            'answer': answer_text,
            'type': q_type,
        })
    
    # Формируем текст с вопросами и ответами
    answers_text = "ВОПРОСЫ И ОТВЕТЫ КАНДИДАТА:\n\n"
    for block_name, block_answers in blocks.items():
        answers_text += f"=== {block_name.upper()} ===\n"
        for item in block_answers:
            q_type_marker = f"({item['type']})" if item.get('type') else ""
            answers_text += f"Вопрос {item['question_number']} {q_type_marker}: {item['answer']}\n"
        answers_text += "\n"
    
    # Промпт для Gemini согласно методологии
    prompt = f"""Ты — эксперт-психолог и HR-аналитик.
Твоя задача — обработать ответы кандидата, подсчитать баллы по 10 шкалам и составить развернутый психологический портрет.

### 1. АЛГОРИТМ ПОДСЧЕТА БАЛЛОВ
В тесте используется 10 блоков (качеств). В каждом блоке вопросы делятся на:
- **Прямые (+):** Описывают желательное поведение.
- **Обратные (-):** Описывают нежелательное поведение, проблемы или слабости.

**Правила начисления баллов (строго по методологии):**
- Если вопрос ПРЯМОЙ (+) и ответ «Да» → **+1 балл**. (Ответ «Нет» = 0).
- Если вопрос ОБРАТНЫЙ (-) и ответ «Нет» → **+1 балл**. (Ответ «Да» = 0, так как это признание проблемы).
- Ответ «Иногда» → **0.5 балла** (в любом случае).

*Максимальный балл по каждой шкале: 20.*

### 2. ШКАЛЫ ОЦЕНКИ (Нормы)
Используй эту градацию для вердикта по каждому качеству:
- **0–6 баллов:** Низкий уровень (Зона риска / Проблема).
- **7–14 баллов:** Средний уровень (Норма).
- **15–20 баллов:** Высокий уровень (Сильная сторона).
*Важно: Если балл 19–20, отметь вероятность "социальной желательности" (кандидат мог пытаться выглядеть идеальным).*

### 3. СПИСОК КАЧЕСТВ ДЛЯ АНАЛИЗА
1. **Внимательность** (Точность, детали, рутина).
2. **Позитивность** (Отсутствие токсичности, отношение к людям).
3. **Самообладание** (Стрессоустойчивость, контроль эмоций).
4. **Ответственность** (Внутренний локус контроля, дисциплина).
5. **Уверенность** (Принятие решений, решительность).
6. **Активность** (Энергия, темп работы).
7. **Настойчивость** (Доведение дел до конца).
8. **Объективность** (Реалистичность, адекватность восприятия).
9. **Чуткость** (Эмпатия, понимание людей).
10. **Общительность** (Коммуникабельность).

---

### ВХОДНЫЕ ДАННЫЕ (Вопросы и Ответы кандидата):
{answers_text}

---

### ФОРМАТ ОТЧЕТА (Выведи результат в таком виде):

#### ЧАСТЬ 1: ЦИФРОВОЙ ПРОФИЛЬ
Выведи график в виде горизонтальных полос для каждого качества. Формат должен быть таким:

Внимательность [████████████░░░░░░░░] 11.5/20 (Средний уровень)
Позитивность [██████████░░░░░░░░░░░░] 10.5/20 (Средний уровень)
Самообладание [████████████████████] 18.0/20 (Высокий уровень)
...и так далее для всех 10 качеств

Для каждого качества:
- Название качества
- Горизонтальная полоса из символов █ (заполненные) и ░ (пустые), где длина полосы пропорциональна баллу (максимум 20 символов для 20 баллов)
- Балл (число с одним знаком после запятой)
- Уровень в скобках (Низкий уровень / Средний уровень / Высокий уровень)

Все 10 качеств:
1. Внимательность
2. Позитивность
3. Самообладание
4. Ответственность
5. Уверенность
6. Активность
7. Настойчивость
8. Объективность
9. Чуткость
10. Общительность

#### ЧАСТЬ 2: ДЕТАЛЬНАЯ РАСШИФРОВКА
Для каждого из 10 качеств напиши мини-анализ (2-3 предложения), опираясь на полученный балл.
- **Если уровень Низкий:** Объясни, в чем риск (например: "Склонен бросать дела на полпути", "Токсичен в коллективе").
- **Если уровень Высокий:** Опиши суперсилу (например: "Отличный финишер", "Стрессоустойчив").
- Используй терминологию теста (например, "Синдром лучшего", "Может лениться", если подходят под паттерн).

#### ЧАСТЬ 3: ОБЩАЯ КАРТИНА ЛИЧНОСТИ
1. **Сильные стороны:** Перечисли 3 главных качества кандидата с подробным описанием каждого (по 2-3 предложения для каждого качества).
2. **Зоны риска:** Подробно опиши, какие черты могут мешать работе? (Особенно обрати внимание на низкую Позитивность, Ответственность или Объективность). Для каждой зоны риска дай развернутое описание (по 2-3 предложения).
3. **Рекомендация по должности:** Дай подробную рекомендацию: Для какой работы этот человек создан (например, кропотливая работа с документами), а какая ему противопоказана (например, активные продажи)? Обоснуй каждую рекомендацию (3-4 предложения).

ВАЖНО: 
- Отчет должен быть полным и детальным. Не сокращай описание!
- Каждая часть отчета должна быть полностью раскрыта.
- График должен быть для всех 10 качеств.
- Детальная расшифровка должна быть для всех 10 качеств.
- Все три части отчета должны быть полностью заполнены."""
    
    try:
        # Вызываем Gemini API
        report = call_gemini(prompt)
        
        # Парсим баллы из отчета (попытка извлечь структурированные данные)
        scores = {}
        lines = report.split('\n')
        for line in lines:
            if '|' in line and 'Качество' not in line and '---' not in line:
                parts = [p.strip() for p in line.split('|') if p.strip()]
                if len(parts) >= 3:
                    quality = parts[0]
                    try:
                        score = float(parts[1].split()[0])
                        level = parts[2]
                        scores[quality] = {
                            'score': score,
                            'level': level.lower() if 'низкий' in level.lower() else ('high' if 'высокий' in level.lower() else 'medium'),
                        }
                    except:
                        pass
        
        report_json = {
            'scores': scores,
            'full_report': report,
            'answers': answers_data,
        }
        
        return {
            'scores_json': scores,
            'report': report,
            'report_json': report_json,
        }
    except Exception as e:
        # Fallback на простую обработку при ошибке API
        return {
            'scores_json': {},
            'report': f"Ошибка обработки с помощью ИИ: {str(e)}\n\nОтветы кандидата:\n{answers_text}",
            'report_json': {
                'error': str(e),
                'answers': answers_data,
            },
        }
