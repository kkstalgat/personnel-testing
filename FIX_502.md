# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 502 Bad Gateway

## üö® –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Gunicorn

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å
sudo systemctl status personnel_testing

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç–µ
sudo systemctl start personnel_testing

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–Ω–æ–≤–∞
sudo systemctl status personnel_testing
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∫–µ—Ç–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–æ–∫–µ—Ç
ls -la /var/www/personnel_testing/personnel_testing.sock

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
# –°–æ–∫–µ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç Gunicorn
# –ò Nginx –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```bash
# –£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç Gunicorn
ps aux | grep gunicorn | head -1

# –£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç Nginx
ps aux | grep nginx | head -1

# –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∫–µ—Ç (–∑–∞–º–µ–Ω–∏—Ç–µ deploy –Ω–∞ –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
sudo chown deploy:www-data /var/www/personnel_testing/personnel_testing.sock
sudo chmod 660 /var/www/personnel_testing/personnel_testing.sock
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –õ–æ–≥–∏ Nginx
sudo tail -n 50 /var/log/nginx/error.log

# –õ–æ–≥–∏ Gunicorn
sudo tail -n 50 /var/www/personnel_testing/logs/error.log

# –õ–æ–≥–∏ systemd
sudo journalctl -u personnel_testing -n 50
```

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞

```bash
sudo systemctl status personnel_testing --no-pager -l
```

**–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω:**
```bash
sudo systemctl start personnel_testing
sudo systemctl enable personnel_testing  # –î–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
```

**–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –ø–∞–¥–∞–µ—Ç:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u personnel_testing -n 100

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo /var/www/personnel_testing/venv/bin/gunicorn --check-config \
    --config /var/www/personnel_testing/gunicorn_config.py \
    personnel_testing.wsgi:application
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∫–µ—Ç–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–æ–∫–µ—Ç–∞
ls -la /var/www/personnel_testing/personnel_testing.sock

# –ï—Å–ª–∏ —Å–æ–∫–µ—Ç–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Gunicorn
sudo systemctl restart personnel_testing

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–Ω–æ–≤–∞
ls -la /var/www/personnel_testing/personnel_testing.sock
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```bash
# –£–∑–Ω–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Gunicorn –∏–∑ systemd service
sudo cat /etc/systemd/system/personnel_testing.service | grep User

# –£–∑–Ω–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Nginx
ps aux | grep nginx | grep master | awk '{print $1}'

# –û–±—ã—á–Ω–æ —ç—Ç–æ www-data –∏–ª–∏ nginx
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∫–µ—Ç
ls -la /var/www/personnel_testing/personnel_testing.sock

# –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ (–ø—Ä–∏–º–µ—Ä –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy –∏ –≥—Ä—É–ø–ø—ã www-data)
sudo chown deploy:www-data /var/www/personnel_testing/personnel_testing.sock
sudo chmod 660 /var/www/personnel_testing/personnel_testing.sock
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
sudo nginx -t

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑–∞–Ω –ø—É—Ç—å –∫ —Å–æ–∫–µ—Ç—É
sudo grep -A 5 "proxy_pass" /etc/nginx/sites-available/personnel_testing

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
# proxy_pass http://unix:/var/www/personnel_testing/personnel_testing.sock;
```

### –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Gunicorn
sudo systemctl restart personnel_testing

# –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 —Å–µ–∫—É–Ω–¥—ã
sleep 3

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
sudo systemctl status personnel_testing

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Nginx
sudo systemctl reload nginx
# –∏–ª–∏
sudo systemctl restart nginx
```

---

## üîç –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã 502

### 1. Gunicorn –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–°–∏–º–ø—Ç–æ–º—ã:**
- `systemctl status` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `inactive` –∏–ª–∏ `failed`
- –°–æ–∫–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```bash
sudo systemctl start personnel_testing
sudo systemctl status personnel_testing
```

### 2. –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö Nginx: `connect() to unix:/var/www/personnel_testing/personnel_testing.sock failed (13: Permission denied)`
- –°–æ–∫–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–∑–Ω–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GUNICORN_USER=$(ps aux | grep "[g]unicorn" | head -1 | awk '{print $1}')
NGINX_USER=$(ps aux | grep "[n]ginx.*master" | head -1 | awk '{print $1}')

# –ï—Å–ª–∏ NGINX_USER –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ www-data (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Nginx)
if [ -z "$NGINX_USER" ]; then
    NGINX_USER="www-data"
fi

# –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∫–µ—Ç
sudo chown $GUNICORN_USER:$NGINX_USER /var/www/personnel_testing/personnel_testing.sock
sudo chmod 660 /var/www/personnel_testing/personnel_testing.sock

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ Nginx
sudo systemctl reload nginx
```

**–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:**

1. –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ (—Å–∫—Ä–∏–ø—Ç `fix_socket_permissions.sh` —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ):
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ —Å–¥–µ–ª–∞–π—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
sudo cp /var/www/personnel_testing/fix_socket_permissions.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/fix_socket_permissions.sh
```

2. –î–æ–±–∞–≤—å—Ç–µ –≤ systemd service —Ñ–∞–π–ª `/etc/systemd/system/personnel_testing.service`:
```ini
[Service]
...
ExecStartPost=/usr/local/bin/fix_socket_permissions.sh
```

3. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
sudo systemctl daemon-reload
sudo systemctl restart personnel_testing
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç** (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):
```ini
[Service]
...
ExecStartPost=/bin/bash -c 'sleep 2 && chown ubuntu:www-data /var/www/personnel_testing/personnel_testing.sock && chmod 660 /var/www/personnel_testing/personnel_testing.sock'
```

### 3. –°–æ–∫–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–æ–∫–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Gunicorn
- –í –ª–æ–≥–∞—Ö: –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–∫–µ—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
ls -la /var/www/personnel_testing/ | grep personnel_testing.sock

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
sudo -u deploy touch /var/www/personnel_testing/test_socket
sudo rm /var/www/personnel_testing/test_socket

# –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞
sudo chown -R deploy:deploy /var/www/personnel_testing
```

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ–∫–µ—Ç—É –≤ Nginx

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö Nginx: `no such file or directory`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
sudo grep "proxy_pass" /etc/nginx/sites-available/personnel_testing

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å gunicorn_config.py
sudo grep "bind" /var/www/personnel_testing/gunicorn_config.py
```

### 5. Gunicorn –ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –Ω–æ —Å—Ä–∞–∑—É –ø–∞–¥–∞–µ—Ç
- –í –ª–æ–≥–∞—Ö systemd –≤–∏–¥–Ω—ã –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u personnel_testing -n 100

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo /var/www/personnel_testing/venv/bin/gunicorn --check-config \
    --config /var/www/personnel_testing/gunicorn_config.py \
    personnel_testing.wsgi:application

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
sudo cat /etc/systemd/system/personnel_testing.service | grep Environment
```

---

## üõ†Ô∏è –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

```bash
echo "=== –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ ===" && \
sudo systemctl status personnel_testing --no-pager -l && \
echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∫–µ—Ç–∞ ===" && \
ls -la /var/www/personnel_testing/personnel_testing.sock 2>&1 && \
echo -e "\n=== –ü—Ä–æ—Ü–µ—Å—Å—ã Gunicorn ===" && \
ps aux | grep gunicorn | grep -v grep && \
echo -e "\n=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Nginx ===" && \
sudo tail -n 20 /var/log/nginx/error.log && \
echo -e "\n=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Gunicorn ===" && \
sudo tail -n 20 /var/www/personnel_testing/logs/error.log
```

---

## ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ)

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl stop personnel_testing
sudo systemctl stop nginx

# 2. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Å–æ–∫–µ—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
sudo rm -f /var/www/personnel_testing/personnel_testing.sock

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
sudo chown -R deploy:deploy /var/www/personnel_testing
sudo chmod 755 /var/www/personnel_testing

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Gunicorn
sudo systemctl start personnel_testing
sleep 3

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∫–µ—Ç
ls -la /var/www/personnel_testing/personnel_testing.sock

# 6. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∫–µ—Ç
sudo chown deploy:www-data /var/www/personnel_testing/personnel_testing.sock
sudo chmod 660 /var/www/personnel_testing/personnel_testing.sock

# 7. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Nginx
sudo systemctl start nginx

# 8. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
sudo systemctl status personnel_testing
sudo systemctl status nginx
```

---

## üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ª–æ–≥–∏:
   ```bash
   sudo journalctl -u personnel_testing -n 100
   sudo tail -n 100 /var/log/nginx/error.log
   sudo tail -n 100 /var/www/personnel_testing/logs/error.log
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
   ```bash
   sudo nginx -t
   sudo /var/www/personnel_testing/venv/bin/gunicorn --check-config \
       --config /var/www/personnel_testing/gunicorn_config.py \
       personnel_testing.wsgi:application
   ```

3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å Gunicorn –≤—Ä—É—á–Ω—É—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
   ```bash
   cd /var/www/personnel_testing
   source venv/bin/activate
   gunicorn --config gunicorn_config.py personnel_testing.wsgi:application
   ```
